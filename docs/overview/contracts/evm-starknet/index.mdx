import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# EVM & Starknet Contracts

The EVM and Starknet contract deployments share a **modular architecture** — the protocol logic is decomposed into small, composable contract modules that can be combined and upgraded independently. The same architectural design is implemented on both platforms, with each module fulfilling an identical role.

![EVM & Starknet smart contract architecture](/img/EVM-starknet-smart-contracts.svg)

## Architecture

The contract system is built around a handler pattern. Instead of encoding swap logic directly into a monolithic contract, the system separates **what holds the funds** (escrow manager, SPV vault) from **how claims and refunds are verified** (pluggable handlers). This allows new swap types to be added by deploying a new handler contract, without modifying any existing contracts.

The modules fall into four layers:

1. **Infrastructure** — Bitcoin light client and shared utilities
2. **Handlers** — Pluggable claim and refund condition verifiers
3. **Orchestration** — Escrow manager that coordinates swaps using handlers
4. **Applications** — SPV swap vault and execution contract for advanced flows

---

## Infrastructure

### Bitcoin Relay (BTC Light Client)

A permissionless, trustless Bitcoin SPV light client deployed on-chain. It verifies and stores Bitcoin block headers using proof-of-work validation, serving as a **trustless oracle of Bitcoin state**. Any participant can submit block headers — the contract verifies their validity regardless of who submits them.

The relay validates consensus rules (PoW difficulty, difficulty adjustments, previous block hash, timestamps) and handles forks automatically by adopting the chain with the greatest cumulative chainwork. Block header data is stored efficiently — on EVM as calldata with only a hash fingerprint on-chain, and on Starknet as events with Poseidon hash fingerprints in storage.

The relay is the cryptographic anchor for all Bitcoin-verified claim handlers and the SPV swap vault.

### Bitcoin Utilities

Low-level Bitcoin protocol utilities used by claim handlers and the SPV vault: transaction parsing, Merkle proof verification, endianness conversion, and compact size encoding.

### Token Utilities

Unified interface for ERC20 and native token transfers, used by the escrow manager, SPV vault, and execution contract.

---

## Handlers

All claim handlers implement a common `IClaimHandler` interface and all refund handlers implement `IRefundHandler`. The escrow manager calls these polymorphically — it doesn't need to know which specific handler is being used for a given swap.

### Claim Handlers

#### Hashlock Claim Handler

Validates claims based on knowledge of a SHA-256 preimage. Used for **Lightning Network swaps** (both directions), where the preimage links the on-chain escrow to the off-chain Lightning payment.

#### Bitcoin Output Claim Handler

Verifies that a specific Bitcoin transaction output exists and is confirmed on the canonical chain (via the BTC relay and Merkle proof). Used for **Bitcoin on-chain → Smart chain** swaps.

#### Bitcoin Nonced Output Claim Handler

Same as the output claim handler, but additionally verifies a nonce encoded in the Bitcoin transaction's `locktime` and `nSequence` fields. The nonce uniquely identifies each swap. Used for **Smart chain → Bitcoin on-chain** swaps.

#### Bitcoin TxID Claim Handler

Verifies that a specific Bitcoin transaction ID is confirmed on the canonical chain. Currently unused — reserved for future swap types such as Ordinals, Runes, or RGB.

### Refund Handlers

#### Timelock Refund Handler

Validates refunds after a specified expiry timestamp. This is the universal refund handler used by **all current swap types** — it ensures the offerer can reclaim funds if the counterparty fails to claim within the timeout period.

---

## Orchestration

### Escrow Manager

The central contract that manages swap escrows. It handles initialization, claiming, refunding, and cooperative closing of escrows by delegating verification to the appropriate claim and refund handlers.

The escrow manager includes three built-in components:

- **LP Vault** — LPs deposit funds that can be used across multiple swaps without per-swap pre-locking. Tracked per LP per token.
- **Reputation Tracker** — Records swap outcomes (success, failed, cooperative refund) per LP, enabling users to identify reliable liquidity providers.
- **Escrow Storage** — Manages escrow lifecycle states: `NOT_COMMITTED → COMMITTED → CLAIMED / REFUNDED`.

Each escrow specifies an offerer (funder), claimer (recipient), token, amount, a claim handler with committed claim data, a refund handler with committed refund data, and optional fields for security deposits, claimer bounties, and post-swap execution.

---

## Applications

### SPV Swap Vault

Implements the [UTXO-controlled vault](/overview/core-primitives/utxo-controlled-vault/) primitive for **Bitcoin on-chain → Smart chain** swaps. The vault holds LP liquidity on the smart chain, and withdrawals are authorized solely by verified Bitcoin transactions using the BTC relay.

The vault tracks a specific Bitcoin UTXO as its ownership reference. Each withdrawal must spend the current UTXO and produce a new one, enforcing a strict linear sequence of operations via Bitcoin's consensus rules. Withdrawal parameters (recipient, amounts, fees) are encoded in the Bitcoin transaction's `OP_RETURN` output and `nSequence` fields.

The vault supports **liquidity fronting** (third parties can front funds before Bitcoin confirmation for a fee) and **caller fees** (watchtower incentives for submitting proofs).

### Execution Contract

Allows scheduling and executing arbitrary smart contract calls as part of a swap. When a swap includes an execution action, the claimed funds are transferred to the execution contract instead of directly to the recipient. Any third party can then execute the scheduled action and earn an execution fee.

This enables use cases like swapping Bitcoin directly into a DeFi position — e.g., the swap output can be routed into an AMM swap or a lending deposit in a single flow. If the execution fails or the action data is lost, funds can be refunded after an expiry period.

---

## Source Code

| Module | EVM | Starknet |
|---|---|---|
| BTC Relay | [contracts/btc_relay](https://github.com/atomiqlabs/atomiq-contracts-evm/tree/main/contracts/btc_relay) | [packages/btc_relay](https://github.com/atomiqlabs/atomiq-contracts-starknet/tree/main/packages/btc_relay) |
| Bitcoin Utilities | [contracts/btc_utils](https://github.com/atomiqlabs/atomiq-contracts-evm/tree/main/contracts/btc_utils) | [packages/btc_utils](https://github.com/atomiqlabs/atomiq-contracts-starknet/tree/main/packages/btc_utils) |
| Token Utilities | [contracts/transfer_utils](https://github.com/atomiqlabs/atomiq-contracts-evm/tree/main/contracts/transfer_utils) | [packages/erc20_utils](https://github.com/atomiqlabs/atomiq-contracts-starknet/tree/main/packages/erc20_utils) |
| Escrow Manager | [contracts/escrow_manager](https://github.com/atomiqlabs/atomiq-contracts-evm/tree/main/contracts/escrow_manager) | [packages/escrow_manager](https://github.com/atomiqlabs/atomiq-contracts-starknet/tree/main/packages/escrow_manager) |
| SPV Swap Vault | [contracts/spv_swap_vault](https://github.com/atomiqlabs/atomiq-contracts-evm/tree/main/contracts/spv_swap_vault) | [packages/spv_swap_vault](https://github.com/atomiqlabs/atomiq-contracts-starknet/tree/main/packages/spv_swap_vault) |
| Execution Contract | [contracts/execution_contract](https://github.com/atomiqlabs/atomiq-contracts-evm/tree/main/contracts/execution_contract) | [packages/execution_contract](https://github.com/atomiqlabs/atomiq-contracts-starknet/tree/main/packages/execution_contract) |
| Hashlock Claim Handler | [contracts/hashlock_claim_handler](https://github.com/atomiqlabs/atomiq-contracts-evm/tree/main/contracts/hashlock_claim_handler) | [packages/hashlock_claim_handler](https://github.com/atomiqlabs/atomiq-contracts-starknet/tree/main/packages/hashlock_claim_handler) |
| Output Claim Handler | [contracts/btc_output_claim_handler](https://github.com/atomiqlabs/atomiq-contracts-evm/tree/main/contracts/btc_output_claim_handler) | [packages/btc_output_claim_handler](https://github.com/atomiqlabs/atomiq-contracts-starknet/tree/main/packages/btc_output_claim_handler) |
| Nonced Output Claim Handler | [contracts/btc_nonced_output_claim_handler](https://github.com/atomiqlabs/atomiq-contracts-evm/tree/main/contracts/btc_nonced_output_claim_handler) | [packages/btc_nonced_output_claim_handler](https://github.com/atomiqlabs/atomiq-contracts-starknet/tree/main/packages/btc_nonced_output_claim_handler) |
| TxID Claim Handler | [contracts/btc_txid_claim_handler](https://github.com/atomiqlabs/atomiq-contracts-evm/tree/main/contracts/btc_txid_claim_handler) | [packages/btc_txid_claim_handler](https://github.com/atomiqlabs/atomiq-contracts-starknet/tree/main/packages/btc_txid_claim_handler) |
| Timelock Refund Handler | [contracts/timelock_refund_handler](https://github.com/atomiqlabs/atomiq-contracts-evm/tree/main/contracts/timelock_refund_handler) | [packages/timelock_refund_handler](https://github.com/atomiqlabs/atomiq-contracts-starknet/tree/main/packages/timelock_refund_handler) |

---

## Swap Type Routing

Different swap directions use different combinations of handlers and vault types:

| Swap Direction | Claim Handler | Refund Handler | Vault |
|---|---|---|---|
| Lightning → Smart chain | Hashlock | Timelock | Escrow Manager |
| Smart chain → Lightning | Hashlock | Timelock | Escrow Manager |
| Bitcoin on-chain → Smart chain | — | — | SPV Swap Vault |
| Smart chain → Bitcoin on-chain | Nonced Output | Timelock | Escrow Manager |

